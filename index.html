<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zumbido 2.0</title>
    <style>
        :root {
            --msn-blue: #0089ff;
            --bg: #f5f5f5;
        }

        body {
            font-family: sans-serif;
            background: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        #app {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        .btn {
            background: var(--msn-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 1rem;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 2rem;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        #log {
            font-size: 11px;
            color: #888;
            text-align: left;
            margin-top: 1rem;
            max-height: 100px;
            overflow-y: auto;
            background: #eee;
            padding: 5px;
        }
    </style>
</head>

<body>
    <div id="app">
        <h1 id="title">Zumbido</h1>

        <div id="auth-section">
            <p>Conecta para empezar a zumbar.</p>
            <button id="login-btn" class="btn">Ingresar con Google</button>
        </div>

        <div id="main-section" class="hidden">
            <div class="user-info">
                <img id="user-photo" class="avatar">
                <span id="user-name"></span>
            </div>
            <p>¡App activa! Prueba a enviarte un zumbido.</p>
            <button id="buzz-btn" class="btn">¡Enviar Zumbido (Prueba)!</button>
            <button id="logout-btn"
                style="margin-top:20px; background:none; border:none; color:red; cursor:pointer;">Cerrar sesión</button>
        </div>

        <div id="log">Logs del sistema inicializados...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, onSnapshot, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAl_jrOOxnMuBpWGRB_dxdvao39GMhlV-Y",
            authDomain: "studio-1888292451-fc60d.firebaseapp.com",
            projectId: "studio-1888292451-fc60d",
            storageBucket: "studio-1888292451-fc60d.firebasestorage.app",
            messagingSenderId: "873003768289",
            appId: "1:873003768289:web:5e3d7a85ebaea725469aa0"
        };

        const logger = (msg) => {
            const logEl = document.getElementById('log');
            logEl.innerHTML += `<div>> ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            logger("Firebase inicializado correctamente.");

            const authSection = document.getElementById('auth-section');
            const mainSection = document.getElementById('main-section');
            const userName = document.getElementById('user-name');
            const userPhoto = document.getElementById('user-photo');

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    logger("Usuario autenticado: " + user.displayName);
                    userName.innerText = user.displayName;
                    userPhoto.src = user.photoURL;
                    authSection.classList.add('hidden');
                    mainSection.classList.remove('hidden');
                    listenForBuzzes(user, db);
                } else {
                    logger("No hay sesión activa.");
                    authSection.classList.remove('hidden');
                    mainSection.classList.add('hidden');
                }
            });

            document.getElementById('login-btn').addEventListener('click', () => {
                logger("Iniciando login...");
                signInWithPopup(auth, provider)
                    .then(() => logger("Login exitoso."))
                    .catch(err => logger("ERROR LOGIN: " + err.code));
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                signOut(auth).then(() => logger("Sesión cerrada."));
            });

            document.getElementById('buzz-btn').addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) return;
                logger("Enviando zumbido...");
                try {
                    await addDoc(collection(db, "buzzes"), {
                        toName: user.displayName,
                        from: user.displayName,
                        timestamp: serverTimestamp(),
                        deviceId: "tester"
                    });
                    logger("Zumbido guardado en Firestore.");
                } catch (e) {
                    logger("ERROR BUZZ: " + e.message);
                }
            });

        } catch (e) {
            logger("ERROR CRÍTICO: " + e.message);
        }

        function listenForBuzzes(user, db) {
            logger("Escuchando zumbidos para: " + user.displayName);
            const q = query(
                collection(db, "buzzes"),
                where("toName", "==", user.displayName),
                orderBy("timestamp", "desc"),
                limit(1)
            );

            let firstLoad = true;
            onSnapshot(q, (snap) => {
                if (firstLoad) { firstLoad = false; return; }
                snap.docChanges().forEach(change => {
                    if (change.type === "added") {
                        logger("¡ZUMBIDO RECIBIDO!");
                        document.body.style.background = "red";
                        setTimeout(() => document.body.style.background = "#f5f5f5", 500);
                        if (navigator.vibrate) navigator.vibrate(500);
                    }
                });
            });
        }
    </script>
</body>

</html>